---
title: "Descriptive Data"
format: bookup-html
---

```{r setup, include=FALSE}
# Load required libraries
library(leaflet)
library(tidyverse)
library(viridis)
library(ggplot2)
library(dplyr)
library(plotly)
library(sf)
library(htmltools)

```

```{r data-import, include=FALSE}
# Import spatial data
library(sf)
model_data_hpi <- st_read("data/model_data_hpi.shp")
```


# Spatial Distribution of Utah's Correctional Population

```{r spatial, echo=FALSE}
# Assuming model_data_hpi is your dataset
leaflet(model_data_hpi) %>%
  addTiles() %>%
  addPolygons(
    fillColor = ~colorQuantile("YlOrRd", corr_rt)(corr_rt),
    fillOpacity = 0.7,
    weight = 1,
    color = "#FFFFFF",
    popup = ~paste(
      "<strong>Tract:</strong>", NAM, "<br>",
      "<strong>Rate:</strong>", round(corr_rt, 2), "<br>",
      "<strong>Hispanic:</strong>", round(phisp, 2), "<br>",
      "<strong>Unemployment:</strong>", round(punemp, 2)
    )
  ) %>%
  addLegend(
    position = "bottomright",
    pal = colorQuantile("YlOrRd", model_data_hpi$corr_rt),
    values = model_data_hpi$corr_rt,
    title = "Correctional Population Rate </br>per 1000 individuals"
  )
```

# Correctional Population Outlier Analysis

This section presents outlier analysis for correctional population counts (`corr_pop`) and rates (`corr_rate`) using different outlier treatment approaches.

This analysis examines correctional population patterns using:

- **Population Counts (`corr_pop`)**: Raw counts of individuals under supervision in each census tract

- **Population Rates (`corr_rate`)**: Rates per 1,000 population for standardized comparison in each census tractw

::: {.panel-tabset}
## Distribution Histogram: Correctional Population
```{r}
#| echo: false
#| results: asis
htmltools::tags$iframe(
  src = "descriptive/corr_pop_histogram.html",
  width = "100%",
  height = "600px",
  frameborder = "0",
  style = "border: none;"
)

```

## Distribution Histogram: Correctional Rate
```{r}
#| echo: false
#| results: asis
htmltools::tags$iframe(
  src = "descriptive/corr_rate_histogram.html",
  width = "100%",
  height = "600px",
  frameborder = "0",
  style = "border: none;"
)
```

:::

# Distribution Tables

- **High Outliers (95th Percentile) Correctional Population**: 196.8

- **High Outliers (95th Percentile) Correctional Rate**: 45.69

- **Low Outliers (5th Percentile) Correctional Population**: 11

- **Low Outliers (5th Percentile) Correctional Rate**: 2.73


## Summary Table
```{r}
#| echo: false
#| results: asis
htmltools::tags$iframe(
  src = "descriptive/summary_table_flextable.html",
  width = "100%",
  height = "600px", 
  frameborder = "0"
)

```


<br>

::: {.panel-tabset}

## Population Counts - Low Outlier Treatment
````{r}
#| echo: false
#| results: asis

htmltools::div(
  # Inline table (smaller)
  htmltools::div(
    style = "position: relative; border: 1px solid #ddd; margin: 1rem 0;",
    htmltools::tags$button(
      onclick = "openModal('table-modal-1')",  # Unique ID: table-modal-1
      style = "position: absolute; top: 5px; right: 5px; z-index: 100; background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;",
      "üîç View Full Size"
    ),
    htmltools::tags$iframe(
      src = "descriptive/corr_pop_LOW_outliers_table.html",
      width = "100%",
      height = "400px",
      frameborder = "0",
      style = "transform: scale(0.8); transform-origin: top left; width: 125%; height: 500px;"
    )
  ),
  
  # Modal overlay with unique ID
  htmltools::div(
    id = "table-modal-1",  # Unique ID: table-modal-1
    style = "display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);",
    htmltools::div(
      style = "position: relative; margin: 2% auto; width: 95%; height: 90%; background: white; border-radius: 8px; padding: 20px;",
      htmltools::tags$button(
        onclick = "closeModal('table-modal-1')",  # Unique ID: table-modal-1
        style = "position: absolute; top: 10px; right: 15px; background: #dc3545; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-weight: bold;",
        "‚úï Close"
      ),
      htmltools::tags$iframe(
        src = "descriptive/corr_pop_LOW_outliers_table.html",
        width = "100%",
        height = "95%",
        frameborder = "0"
      )
    )
  )
)
````

## Population Counts - High Outlier Treatment
````{r}
#| echo: false
#| results: asis

htmltools::div(
  # Inline table (smaller)
  htmltools::div(
    style = "position: relative; border: 1px solid #ddd; margin: 1rem 0;",
    htmltools::tags$button(
      onclick = "openModal('table-modal-2')",  # Unique ID: table-modal-2
      style = "position: absolute; top: 5px; right: 5px; z-index: 100; background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;",
      "üîç View Full Size"
    ),
    htmltools::tags$iframe(
      src = "descriptive/corr_pop_HIGH_outliers_table.html",
      width = "100%",
      height = "400px",
      frameborder = "0",
      style = "transform: scale(0.8); transform-origin: top left; width: 125%; height: 500px;"
    )
  ),
  
  # Modal overlay with unique ID
  htmltools::div(
    id = "table-modal-2",  # Unique ID: table-modal-2
    style = "display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);",
    htmltools::div(
      style = "position: relative; margin: 2% auto; width: 95%; height: 90%; background: white; border-radius: 8px; padding: 20px;",
      htmltools::tags$button(
        onclick = "closeModal('table-modal-2')",  # Unique ID: table-modal-2
        style = "position: absolute; top: 10px; right: 15px; background: #dc3545; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-weight: bold;",
        "‚úï Close"
      ),
      htmltools::tags$iframe(
        src = "descriptive/corr_pop_HIGH_outliers_table.html",
        width = "100%",
        height = "95%",
        frameborder = "0"
      )
    )
  )
)
````

## Population Rates - Low Outlier Treatment
````{r}
#| echo: false
#| results: asis

htmltools::div(
  # Inline table (smaller)
  htmltools::div(
    style = "position: relative; border: 1px solid #ddd; margin: 1rem 0;",
    htmltools::tags$button(
      onclick = "openModal('table-modal-3')",  # Unique ID: table-modal-3
      style = "position: absolute; top: 5px; right: 5px; z-index: 100; background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;",
      "üîç View Full Size"
    ),
    htmltools::tags$iframe(
      src = "descriptive/corr_rate_LOW_outliers_table.html",
      width = "100%",
      height = "400px",
      frameborder = "0",
      style = "transform: scale(0.8); transform-origin: top left; width: 125%; height: 500px;"
    )
  ),
  
  # Modal overlay with unique ID
  htmltools::div(
    id = "table-modal-3",  # Unique ID: table-modal-3
    style = "display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);",
    htmltools::div(
      style = "position: relative; margin: 2% auto; width: 95%; height: 90%; background: white; border-radius: 8px; padding: 20px;",
      htmltools::tags$button(
        onclick = "closeModal('table-modal-3')",  # Unique ID: table-modal-3
        style = "position: absolute; top: 10px; right: 15px; background: #dc3545; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-weight: bold;",
        "‚úï Close"
      ),
      htmltools::tags$iframe(
        src = "descriptive/corr_rate_LOW_outliers_table.html",
        width = "100%",
        height = "95%",
        frameborder = "0"
      )
    )
  )
)
````

## Population Rates - High Outlier Treatment
**Note:** View Full Size of Table, Make sure to scroll to the bottom of the table to see pages of the table to see every outlier observation!

````{r}
#| echo: false
#| results: asis

htmltools::div(
  # Inline table (smaller)
  htmltools::div(
    style = "position: relative; border: 1px solid #ddd; margin: 1rem 0;",
    htmltools::tags$button(
      onclick = "openModal('table-modal-4')",  # Unique ID: table-modal-4
      style = "position: absolute; top: 5px; right: 5px; z-index: 100; background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;",
      "üîç View Full Size"
    ),
    htmltools::tags$iframe(
      src = "descriptive/corr_rate_HIGH_outliers_table.html",
      width = "100%",
      height = "400px",
      frameborder = "0",
      style = "transform: scale(0.8); transform-origin: top left; width: 125%; height: 500px;"
    )
  ),
  
  # Modal overlay with unique ID
  htmltools::div(
    id = "table-modal-4",  # Unique ID: table-modal-4
    style = "display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);",
    htmltools::div(
      style = "position: relative; margin: 2% auto; width: 95%; height: 90%; background: white; border-radius: 8px; padding: 20px;",
      htmltools::tags$button(
        onclick = "closeModal('table-modal-4')",  # Unique ID: table-modal-4
        style = "position: absolute; top: 10px; right: 15px; background: #dc3545; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-weight: bold;",
        "‚úï Close"
      ),
      htmltools::tags$iframe(
        src = "descriptive/corr_rate_HIGH_outliers_table.html",
        width = "100%",
        height = "95%",
        frameborder = "0"
      )
    )
  )
)
````

:::

## Combined Tables
- **Both Population & Rate Tables** are presented below including both HIGH and LOW outliers with flags for treatment center in census tract 

```{r}
#| echo: false
#| results: asis
#htmltools::includeHTML("descriptive/corr_pop_outliers_table.html")

htmltools::div(
  htmltools::div(
    style = "position: relative; border: 1px solid #ddd; margin: 1rem 0;",
    htmltools::tags$button(
      onclick = "openModal('table-modal-5')",  # Unique ID for combined table
      style = "position: absolute; top: 5px; right: 5px; z-index: 100; background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;",
      "üîç View Full Size"
    ),
    htmltools::tags$iframe(
      src = "descriptive/combined_outliers_analysis.html",  # Make sure this is the correct file
      width = "100%",
      height = "400px",
      frameborder = "0",
      style = "transform: scale(0.8); transform-origin: top left; width: 125%; height: 500px;"
    )
  ),
  
  htmltools::div(
    id = "table-modal-5",
    style = "display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);",
    htmltools::div(
      style = "position: relative; margin: 2% auto; width: 95%; height: 90%; background: white; border-radius: 8px; padding: 20px;",
      htmltools::tags$button(
        onclick = "closeModal('table-modal-5')",
        style = "position: absolute; top: 10px; right: 15px; background: #dc3545; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-weight: bold;",
        "‚úï Close"
      ),
      htmltools::tags$iframe(
        src = "descriptive/combined_outliers_analysis.html",
        width = "100%",
        height = "95%",
        frameborder = "0"
      )
    )
  )
)

```


````{r}
#| echo: false
#| results: asis

htmltools::tags$script(HTML("
  function openModal(id) {
    document.getElementById(id).style.display = 'block';
    document.body.style.overflow = 'hidden';
  }
  
  function closeModal(id) {
    document.getElementById(id).style.display = 'none';
    document.body.style.overflow = 'auto';
  }
  
  // Close modal when clicking outside
  window.onclick = function(event) {
    // Check all possible modal IDs
    const modalIds = ['table-modal-1', 'table-modal-2', 'table-modal-3', 'table-modal-4', 'table-modal-5'];
    modalIds.forEach(function(modalId) {
      const modal = document.getElementById(modalId);
      if (modal && event.target === modal) {
        closeModal(modalId);
      }
    });
  }
"))
````


