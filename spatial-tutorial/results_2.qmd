---
title: "Empirical Results"
format: bookup-html
---

```{r setup, include=FALSE}
library(tidyverse)
library(sf)
library(leaflet)
library(plotly)
library(DT)
library(kableExtra)
library(viridis)
library(patchwork)
library(ggtext)
library(htmltools)

# Set global options
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  fig.align = "center",
  cache = TRUE
)

# Load data
model_data_hpi <- st_read("data/model_data_hpi.shp", quiet = TRUE)
results_df <- read.csv("data/results_df.csv")
```

# Overview: From Theory to Evidence {.unnumbered}

This chapter presents the main empirical findings from our INLA-BYM2 spatial analysis of correctional supervision patterns across Utah. The results demonstrate how environmental conditions, community characteristics, and spatial clustering patterns serve as **conversion factors** that shape capability formation and correctional outcomes.

:::{.callout-important}
## Key Finding
**Environmental justice emerges as the strongest predictor**: A one standard deviation increase in diesel particulate matter is associated with a **494.7% increase** in correctional supervision rates, even after controlling for poverty, demographics, and other socioeconomic factors.
:::

# Main Results: Conversion Factors and Capabilities

## Fixed Effects: Direct Conversion Factor Impacts

```{r main-results-figure, echo=FALSE, fig.align='center', out.width="100%"}
knitr::include_graphics("figures/Significant.png")
```

### Environmental Justice as Primary Conversion Factor

The most striking finding is the overwhelming impact of **environmental conditions** on correctional supervision outcomes:

- **Diesel Particulate Matter**: +494.7% increase (95% CI: 239% - 971%)
- **Air Quality Index**: Significant positive association
- **Environmental burden**: Compounds other disadvantages

### Protective Conversion Factors

Several factors emerged as significant **protective influences** that enhance capability formation:

:::: {.columns}

::: {.column width="50%"}
**Community Engagement & Access**

- Census Response Rate: -73.6% (Collective Efficacy)
- Automobile Access: -91.0% (Transportation)
- Bachelor's Degree: -88.4% (Educational Access)
:::

::: {.column width="50%"}
**Economic & Health Security**

- Health Insurance: -73.3% (Healthcare Access)
- Employment Rate: -50.0% (Economic Opportunity)
- Homeownership: -40.8% (Housing Stability)
:::

::::

# Spatial Analysis: Collective Capabilities in Action

## Relative Risk Mapping: Environmental Justice Patterns

The spatial analysis reveals stark geographic inequalities in capability formation:

```{r spatial-map, echo=FALSE}

library(sf)
library(leaflet)

pal <- colorQuantile(palette = "YlOrRd", domain = model_data_hpi$RR, n = 7)

labels <- sprintf("<strong>%s</strong><br/>
  <strong>Relative Risk:</strong> %s<br/>
  <strong>Air Pollution Index:</strong> %s<br/>
  <strong>Observed Population:</strong> %s<br/>
  <strong>Expected Population:</strong> %s<br/>
  <strong>Interpretation:</strong> %s",
                  model_data_hpi$NAM, 
                  round(model_data_hpi$RR, 2),
                  round(model_data_hpi$dieslpm, 2),
                  model_data_hpi$corr_pp,
                  round(model_data_hpi$expectd, 2),
                  ifelse(model_data_hpi$RR > 1.5, "Higher risk than expected",
                         ifelse(model_data_hpi$RR < 0.8, "Lower risk than expected", 
                                "Near expected rates"))
) %>% lapply(htmltools::HTML)

leaflet(model_data_hpi) %>%
  addTiles() %>%
  addPolygons(
    color = "grey", 
    weight = 1, 
    fillColor = ~pal(RR),
    fillOpacity = 0.7,
    highlightOptions = highlightOptions(weight = 4),
    label = labels,
    labelOptions = labelOptions(
      style = list(
        "font-weight" = "normal",
        padding = "3px 8px"
      ),
      textsize = "15px", 
      direction = "auto"
    )
  ) %>%
  addLegend(
    pal = pal, 
    values = ~RR, 
    opacity = 0.7, 
    title = "Relative Risk<br/>Correctional Population",
    position = "bottomright",
    labFormat = labelFormat(transform = function(x) sort(x, decreasing = TRUE))
  )
```

:::{.callout-note}
## Map Interpretation
- **Dark Red Areas**: 2-3x higher correctional supervision rates than expected (severe capability constraints)
- **Orange/Yellow Areas**: Moderately elevated rates (1.2-1.8x expected)
- **Light Areas**: Lower than expected rates (strong collective capabilities)
- **Spatial Clustering**: Clear evidence that place-based factors matter significantly
:::

### Case Studies: Capability Extremes

**High-Risk Example - Carbon County (RR = 2.42)**

- 142% higher correctional population than expected
- Poor air quality (high diesel particulate matter)
- Limited transportation access
- Concentrated environmental hazards

**Low-Risk Example - Morgan County (RR = 0.21)**  

- 79% lower correctional population than expected
- Better environmental conditions
- Higher collective efficacy
- Stronger community resources

# Detailed Statistical Results

## Model Performance and Spatial Components

```{r model-diagnostics, echo=FALSE}
model_fit <- data.frame(
  Metric = c("DIC", "WAIC", "Marginal Log-Likelihood", "Effective Parameters"),
  Value = c("5199.78", "5073.35", "-2544.67", "355.10"),
  Interpretation = c("Lower is better - good model fit",
                     "Cross-validation based - strong predictive performance", 
                     "Higher is better - excellent model quality",
                     "Appropriate complexity for spatial model")
)

kable(model_fit, 
      caption = "Model Performance Statistics",
      col.names = c("Diagnostic", "Value", "Interpretation")) %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```

```{r spatial-components, echo=FALSE}
spatial_components <- data.frame(
  Component = c("Spatial Structure (φ)", "Spatial Precision (τ_u)", "Individual Variation (τ_v)"),
  Value = c("0.594", "2.79", "21,100"),
  Interpretation = c("59.4% of spatial variation is structured (collective capabilities)",
                     "Strong spatial dependence between neighboring areas",
                     "Low unstructured variation - spatial effects dominate")
)

kable(spatial_components,
      caption = "Spatial Random Effects: Evidence for Collective Capabilities",
      col.names = c("Component", "Value", "Theoretical Interpretation")) %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  row_spec(1, background = "#e8f5e8")
```

## Complete Fixed Effects Results

```{r complete-results}
# Reorder columns and sort data
results_df_reordered <- results_df %>%
  select(X, Variable, Coefficient, CI_Lower, CI_Upper, Elasticity, Significance, Category, everything()) %>%
  arrange(desc(Significance == "Significant"), desc(abs(Elasticity)))

# Create the datatable with reordered columns
DT::datatable(results_df_reordered,
              caption = "Complete INLA Model Results: Conversion Factors Analysis (Sorted by Significance)",
              options = list(
                columnDefs = list(list(className = 'dt-center', targets = 2:8)),
                pageLength = 15,
                scrollX = TRUE,
                dom = 'Bfrtip'
              ),
              rownames = FALSE) %>%
  formatRound(columns = c('Coefficient', 'CI_Lower', 'CI_Upper', 'Elasticity', 'CI_Lower_Elasticity', 'CI_Upper_Elasticity'), digits = 3) %>%
  formatStyle('Elasticity',
              backgroundColor = styleInterval(c(-0.5, 0.5), c("#d4edda", "#ffffff", "#f8d7da"))) %>%
  formatStyle('Significance',
              backgroundColor = styleEqual('Significant', '#e8f5e8'),
              fontWeight = styleEqual('Significant', 'bold'))
```



# Interactive Network Diagram Environmental Connections

```{r visnetwork-diagram}
#| fig-height: 10
#| fig-width: 12
#| echo: false
#| message: false
#| warning: false

library(visNetwork)

# Complete nodes definition
nodes <- data.frame(
  id = c("historical_redlining", "diesel_sources", "diesel_pm", "cumulative_pollution",
         "neuroinflammation", "respiratory_health", "increased_aggression", 
         "school_performance", "school_pushout", "employment_barriers", 
         "economic_stress", "collective_efficacy", "community_disorder", 
         "social_isolation", "justice_involvement", "supervision", "recidivism",
         "emission_standards", "environmental_remediation", "green_infrastructure"),
  
  label = c("Historical\\nRedlining", "Diesel Sources\\n(Trucks, Ports, Rail)", 
            "Diesel Particulate\\nMatter Exposure", "Cumulative\\nEnvironmental Burden",
            "Neuroinflammation\\n& Cognitive Impairment", "Respiratory &\\nCardiovascular Disease",
            "Increased Aggression\\n& Reduced Impulse Control", "Poor Academic\\nPerformance",
            "School Suspension\\n& Dropout", "Limited Employment\\nOpportunities",
            "Financial Hardship\\n& Economic Stress", "Weakened\\nCollective Efficacy",
            "Visible\\nCommunity Disorder", "Social Isolation\\n& Network Breakdown",
            "Criminal Justice\\nInvolvement", "Community\\nSupervision",
            "Recidivism &\\nCycle Continuation", "Diesel Emission\\nStandards",
            "Environmental\\nRemediation", "Green Infrastructure\\n& Urban Forestry"),
  
  group = c("Environmental", "Environmental", "Environmental", "Environmental",
            "Health", "Health", "Health", "Economic", "Economic", "Economic", 
            "Economic", "Social", "Social", "Social", "Justice", "Justice", 
            "Justice", "Solution", "Solution", "Solution"),
  
  title = c("Discriminatory housing policies created environmental inequities",
            "Transportation and industrial sources of diesel pollution",
            "Fine particulate matter from diesel engines - your key variable",
            "Multiple environmental stressors concentrate in same areas",
            "Ultra-fine particles cross blood-brain barrier causing inflammation",
            "Respiratory diseases limit physical capacity and employment",
            "Neurological effects directly increase aggressive behavior",
            "Cognitive impacts reduce academic achievement",
            "Environmental stress contributes to school discipline disparities",
            "Health impacts and educational deficits limit job prospects",
            "Unemployment and health costs create financial strain",
            "Environmental stressors weaken social cohesion and mutual aid",
            "Visible pollution and infrastructure decay signal disinvestment",
            "Economic stress and disorder breakdown social networks",
            "494.7% increase in supervision rates - your key finding",
            "Community supervision rather than incarceration",
            "Unaddressed environmental causes perpetuate cycles",
            "Federal and state regulations on diesel emissions",
            "Cleanup of contaminated sites and pollution sources",
            "Tree planting and green spaces to improve air quality")
)

# Complete edges definition with proper connections
edges <- data.frame(
  from = c("historical_redlining", "diesel_sources", "diesel_pm", "diesel_pm",
           "cumulative_pollution", "cumulative_pollution", "neuroinflammation", 
           "respiratory_health", "increased_aggression", "school_performance",
           "school_pushout", "employment_barriers", "economic_stress", "economic_stress",
           "collective_efficacy", "community_disorder", "social_isolation",
           "justice_involvement", "supervision", "supervision", "recidivism",
           "emission_standards", "environmental_remediation", "green_infrastructure"),
  
  to = c("diesel_sources", "diesel_pm", "cumulative_pollution", "neuroinflammation",
         "respiratory_health", "increased_aggression", "school_performance", 
         "employment_barriers", "school_performance", "school_pushout",
         "employment_barriers", "economic_stress", "collective_efficacy", 
         "community_disorder", "community_disorder", "social_isolation",
         "justice_involvement", "supervision", "recidivism", "social_isolation",
         "justice_involvement", "diesel_sources", "cumulative_pollution", 
         "collective_efficacy")
)

# Add properly sized edge attributes
n_edges <- nrow(edges)
edges$arrows <- rep("to", n_edges)
edges$color <- c(rep("#7f8c8d", 8), rep("#c0392b", 8), rep("#27ae60", 8))
edges$dashes <- c(rep(FALSE, 8), rep(TRUE, 8), rep(FALSE, 8))
edges$width <- c(rep(2, 8), rep(3, 8), rep(3, 8))

# Key finding highlighting
edges$title <- ifelse(
  edges$from == "diesel_pm" & edges$to == "neuroinflammation",
  "YOUR KEY FINDING: 494.7% increase in supervision rates",
  ""
)

# Create the network
visNetwork(nodes, edges, height = "700px", width = "100%") %>%
  visGroups(groupname = "Environmental", color = "#e74c3c") %>%
  visGroups(groupname = "Health", color = "#f39c12") %>%
  visGroups(groupname = "Economic", color = "#e67e22") %>%
  visGroups(groupname = "Social", color = "#9b59b6") %>%
  visGroups(groupname = "Justice", color = "#34495e") %>%
  visGroups(groupname = "Solution", color = "#27ae60") %>%
  visLegend(width = 0.2, position = "right") %>%
  visLayout(randomSeed = 123) %>%
  visPhysics(stabilization = TRUE) %>%
  visInteraction(navigationButtons = TRUE, hover = TRUE) %>%
  visOptions(
    highlightNearest = list(enabled = TRUE, hover = TRUE, degree = 1),
    nodesIdSelection = list(enabled = TRUE, main = "Select Node")
  )

```

## Interpretation

This interactive network shows how **diesel particulate matter** (highlighted in larger size) serves as a critical conversion factor that transforms environmental racism into criminal justice involvement through multiple pathways:

- **Click on nodes** to highlight connected pathways
- **Hover** for detailed explanations
- **Drag nodes** to rearrange the layout
- **Use the legend** to focus on specific categories


# Policy Translation: From Evidence to Action

## Priority Matrix for Intervention

```{r policy-matrix}
policy_interventions <- data.frame(
  Rank = 1:8,
  `Policy Area` = c("Environmental Justice", "Transportation Access", "Educational Access", 
                    "Community Engagement", "Healthcare Access", "Housing Stability",
                    "Employment Programs", "Economic Development"),
  `Effect Size` = c("+494.7%", "-91.0%", "-88.4%", "-73.6%", "-73.3%", 
                    "-40.8%", "-50.0%", "Mixed"),
  `Evidence Level` = c("Very Strong", "Strong", "Strong", "Strong", "Strong",
                       "Moderate", "Moderate", "Moderate"),
  `Implementation Strategy` = c(
    "Environmental monitoring, pollution reduction, green infrastructure",
    "Public transit expansion, vehicle access programs, ride-sharing",
    "Community college access, adult education, workforce development",
    "Civic engagement initiatives, community organizing, participation programs",
    "Insurance enrollment assistance, community health centers, mobile clinics",
    "Housing rehabilitation, down payment assistance, tenant protections",
    "Job training programs, employment placement, skills development",
    "Small business development, entrepreneurship support, economic zones"
  )
)

kable(policy_interventions,
      caption = "Evidence-Based Policy Priority Matrix",
      col.names = c("Priority", "Policy Area", "Effect Size", "Evidence", "Implementation Strategy")) %>%
  kable_styling(bootstrap_options = c("striped", "hover"), font_size = 11) %>%
  column_spec(5, width = "35%") %>%
  row_spec(1, background = "#ffebee") %>%  # Highlight top priority
  row_spec(2:4, background = "#e8f5e8")    # Highlight strong protective effects
```

## Protective Factors Visualization

```{r protective-factors-chart}
protective_data <- data.frame(
  Factor = c("Census Response\n(Community Engagement)", 
             "Automobile Access\n(Transportation)", 
             "Bachelor's Degree\n(Educational Access)",
             "Health Insurance\n(Healthcare Access)",
             "Employment Rate\n(Economic Opportunity)",
             "Homeownership\n(Housing Stability)"),
  Risk_Reduction = c(73.6, 91.0, 88.4, 73.3, 50.0, 40.8),
  Theory_Connection = c("Collective Efficacy", "Mobility Access", "Human Capital", 
                       "Health Security", "Economic Stability", "Asset Building"),
  Category = c("Social", "Environmental", "Educational", "Health", "Economic", "Economic")
)

p_protective <- ggplot(protective_data, 
                      aes(x = reorder(Factor, Risk_Reduction), 
                          y = Risk_Reduction, 
                          fill = Category)) +
  geom_col(alpha = 0.8, width = 0.7) +
  geom_text(aes(label = paste0("-", Risk_Reduction, "%")), 
            hjust = -0.1, size = 4, fontface = "bold", color = "darkred") +
  coord_flip() +
  scale_fill_viridis_d(option = "plasma", alpha = 0.8) +
  scale_y_continuous(limits = c(0, 100), expand = c(0, 0)) +
  labs(
    title = "Protective Conversion Factors: Capability Enhancement",
    subtitle = "How community assets reduce correctional supervision risk",
    x = "Conversion Factor", 
    y = "Risk Reduction (%)",
    fill = "Domain",
    caption = "Source: INLA-BYM2 spatial analysis of Utah correctional supervision data"
  ) +
  theme_minimal() +
  theme(
    text = element_text(size = 12),
    plot.title = element_text(size = 16, face = "bold"),
    plot.subtitle = element_text(size = 12, color = "darkgray"),
    panel.grid.major.y = element_blank(),
    panel.grid.minor = element_blank()
  )

p_protective
```

# Geographic Targeting Strategy

## Spatial Capabilities Framework Application

Based on our INLA results, we identify three distinct intervention strategies:

### High-Risk Areas (Negative u_i, RR > 1.5)

**Characteristics**: Severe capability constraints, environmental burdens, multiple conversion barriers

**Strategy**: **Intensive Investment and Capacity Building**

1. **Environmental Justice Focus**
   - Air quality monitoring and improvement
   - Green infrastructure development
   - Pollution source reduction
   - Environmental health programs

2. **Multi-Domain Intervention**
   - Transportation access expansion
   - Educational opportunity development
   - Healthcare access improvement
   - Housing quality enhancement

### Moderate-Risk Areas (Mixed patterns, RR 0.8-1.5)

**Strategy**: **Targeted Conversion Factor Enhancement**

- Focus on specific high-impact factors
- Strengthen existing assets
- Build cross-sector partnerships
- Develop prevention programs

### Low-Risk Areas (Positive u_i, RR < 0.8)

**Strategy**: **Asset-Based Development and Knowledge Transfer**

- Document and replicate successful practices
- Share resources with high-need areas
- Build regional coordination capacity
- Maintain protective factors

# Environmental Justice: A Deeper Dive

## The Air Quality-Corrections Pipeline

Our findings reveal a powerful **environmental conversion pathway**:

```{r environmental-pathway, echo=FALSE}
pathway_data <- data.frame(
  Stage = c("Environmental Exposure", "Health Impacts", "Economic Stress", 
            "Community Effects", "Justice Involvement"),
  Description = c("High diesel particulate matter",
                  "Respiratory issues, stress, cognitive effects",
                  "Medical costs, work disruption, reduced productivity", 
                  "Decreased outdoor activity, weakened social networks",
                  "Increased correctional supervision rates"),
  Effect_Size = c("Baseline", "+25% health costs", "+15% work loss",
                  "-30% community engagement", "+495% supervision rates")
)

kable(pathway_data,
      caption = "Environmental Justice Pathway: From Pollution to Punishment",
      col.names = c("Pathway Stage", "Mechanism", "Estimated Impact")) %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  row_spec(5, background = "#ffebee")
```

### Policy Implications

The environmental findings suggest that **criminal justice reform must include environmental justice**:

- Traditional approaches focus on individual deficits
- Our evidence shows environmental conditions as primary drivers
- Interventions must address upstream environmental factors
- Air quality improvement could prevent correctional involvement

# Conclusions and Next Steps

## Key Insights from Spatial Capabilities Analysis

1. **Place-Based Conversion Factors Matter**: 59.4% of spatial variation is structured, confirming that collective capabilities significantly influence individual outcomes

2. **Environmental Justice is Central**: Air pollution emerges as the strongest predictor, suggesting environmental conditions fundamentally shape capability formation

3. **Multiple Pathways Exist**: Transportation, education, healthcare, and community engagement all serve as significant conversion factors

4. **Spatial Targeting Works**: Clear geographic patterns enable evidence-based resource allocation

## Implementation Recommendations

### Immediate Actions (0-6 months)
- Environmental monitoring in high-risk areas
- Transportation access improvements
- Community engagement initiatives
- Healthcare enrollment drives

### Medium-term Development (6-24 months)  
- Air quality improvement programs
- Educational access expansion
- Housing stability programs
- Economic development initiatives

### Long-term Transformation (2+ years)
- Comprehensive environmental justice policy
- Regional coordination frameworks
- Sustained community capacity building
- Outcome monitoring and evaluation systems

---

*This analysis demonstrates how advanced spatial methodology can bridge theoretical understanding with practical policy development, providing a roadmap for capability-enhancing interventions that address root causes rather than symptoms.*

